<html>
  <head>
    <link rel="stylesheet" href="/css/account-setup.css" />
  </head>

  <body>
    <div id="widget" style="width: 100%; height: 100%; display: none"></div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.2.3/jquery.min.js"></script>

    <script src="https://atrium.mx.com/connect.js"></script>

    <script>
      // Create an instance of MXConnect.
      // Used for setting up any configuration options and registering callbacks.
      var mxConnect = new window.MXConnect({
        id: "widget",
        iframeTitle: "Connect",
        /**
         * Callback that for handling all events withhin connect.
         * Only called in  ui_message_version 4 or higher
         *
         * The events called here are the same events that come through post
         * messages.
         *
         * Details about the events:
         * https://atrium.mx.com/docs#connect-events
         */
        onEvent: function (type, payload) {
          console.log("onEvent", type, payload);
        },
        /**
         * *Deprecated*. Called when the connect widget is mounted in the DOM.
         * Only called if the `ui_message_version` is below `4` or not set all.
         */
        onLoad: function (event) {
          console.log("onLoad", event);
        },
        /**
         * *Deprecated*. Called when a member is successfully 'CONNECTED'.
         * Only called if the `ui_message_version` is below `4` or not set all.
         */
        onSuccess: function (event) {
          console.log("onSuccess", event);
        },
        /**
         * Any configuration options documented can be configured here:
         * https://atrium.mx.com/docs#configuration
         *
         * These values will override any configuration values that were set when
         * the URL was requested.
         */
        // config: {},
        targetOrigin: "*",
      });
    </script>

    <div id="container">
      <img id="logo" src="/img/icon.png" alt="Mintable Logo" />
      <h1>Mintable</h1>
      <h2>Mx Account Setup</h2>
      <div id="accounts"><div id="accounts-table"></div></div>

      <button id="link-button">Link A New Account</button>

      <br />

      <button id="done-button">Done Linking Accounts</button>
    </div>

    <script type="text/javascript">
      (function ($) {
        $.post('/accounts').then(accounts => {
            console.log(accounts)

            if (accounts.length == 0) {
                const text = `<p>No Mx accounts set up yet. Click "Link A New Account" to add one.`
                $('#accounts-table').append(text)
            } else {
                const text = `<h3>Current Accounts</h3>`
                $('#accounts').prepend(text)
                const table = `<table><tr><th>Token</th><th>Name</th><th>Update</th><th>Remove</th></tr></table>`
                $('#accounts-table').append(table)

                accounts.forEach(account => {
                    const updateButton = `<button class="update" data-access-token="${account.token}">Update</button>`
                    const removeButton = `<button class="remove" data-access-token="${account.token}">Remove</button>`
                    const row = `<tr><td>${account.guid}</td><td>${account.name}</td><td>${updateButton}</td><td>${removeButton}</td></tr>`
                    $('#accounts table').append(row)
                })
            }
        })

        $(document).on('click', 'button.update', function(e) {
            access_token = e.currentTarget.getAttribute('data-access-token')
            $.post('/create_link_token', { access_token }).then(link_token => {
                options.token = link_token.link_token
                handler = Mx.create(options)
                handler.open()
            })
        })

        $(document).on('click', 'button.remove', function(e) {
            const confirmed = confirm('Are you sure you want to remove this account? This cannot be undone.')
            if (confirmed === true) {
                token = e.currentTarget.getAttribute('data-access-token')
                $.post('/remove', { token: token }).then(setTimeout(() => location.reload(), 1000))
            }
        })

        $("#link-button").on("click", function (e) {
          console.log("link button clicked");
          $.post("/api/get_mxconnect_widget_url", {}).then((response) => {
            console.log("have url, calling mxConnect.load()");
            // console.log(mxConnect.load)
            $("#container").hide()
            $("#widget").show()
            mxConnect.load(response.url);
            
          });
        });

        $("#done-button").on("click", function (e) {
          $.post("/done").then((data) => {
            $("#container").text(
              "You can now close this page in your browser."
            );
          });
        });
      })(jQuery);
    </script>
  </body>
</html>
